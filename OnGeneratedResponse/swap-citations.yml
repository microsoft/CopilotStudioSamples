kind: AdaptiveDialog
beginDialog:
  kind: OnGeneratedResponse
  id: main
  condition: =CountRows(System.Response.Citations)>0
  actions:
    - kind: SetVariable
      id: setVariable_xHJ4lf
      variable: Topic.Var1
      value: =System.Response.FormattedText

    - kind: SetVariable
      id: setVariable_wtNwaw
      variable: Topic.externalWebsiteURL
      value: 

    - kind: SetVariable
      id: setVariable_9IFwdP
      variable: Topic.CitationsSnip
      value: |-
        =With(
            {CitationsTable: System.Response.Citations},
            Concat(
                ForAll(
                    Sequence(CountRows(CitationsTable)),
                    Value
                ),
                With(
                    {
                        currentRecord: Index(
                            CitationsTable,
                            Value
                        )
                    },
                    // Begin logic - Create Markdown link format for Teams
                    "[" & Text(Value) & "] [" &
                    Substitute(
                        If(
                            Find(
                                "?",
                                Last(
                                    Split(
                                        currentRecord.Name,
                                        "/"
                                    )
                                ).Value
                            ) > 0,
                            Left(
                                Last(
                                    Split(
                                        currentRecord.Name,
                                        "/"
                                    )
                                ).Value,
                                Find(
                                    "?",
                                    Last(
                                        Split(
                                            currentRecord.Name,
                                            "/"
                                        )
                                    ).Value
                                ) - 1
                            ),
                            Last(
                                Split(
                                    currentRecord.Name,
                                    "/"
                                )
                            ).Value
                        ),
                        "%20",
                        " "
                    ) & "](" &
                    If(
                        IsBlank(currentRecord.Url),
                        If(
                            Left(
                                currentRecord.Name,
                                8
                            ) = "https://",
                            Substitute(
                                currentRecord.Name,
                                " ",
                                "%20"
                            ),
                            Substitute((Topic.externalWebsiteURL & currentRecord.Name), " ", "%20") &
                            If(
                                // Check if cited source is a PDF or DOCX and we have page data available
                                And(
                                    Or(
                                        EndsWith(currentRecord.Name, ".pdf"),
                                        EndsWith(currentRecord.Name, ".docx")
                                    ),
                                    StartsWith(currentRecord.Text, "<page value=")
                                ),
                                // Add page anchor for PDFs and DOCX files
                                "#page=" & Mid(
                                    currentRecord.Text,
                                    Find("<page value=", currentRecord.Text) + Len("<page value=") + 1,
                                    Find(
                                        ">",
                                        currentRecord.Text
                                    ) - Len("<page value=") - 3
                                ),
                                ""
                            )
                        ),
                        currentRecord.Url
                    ) & ")"
                    // End logic
                ),
                Char(10) & Char(10)
            )
        )

    - kind: SendActivity
      id: sendActivity_i4mW3G
      activity: |-
        {If(
            System.Activity.ChannelId = "msteams",
            System.Response.FormattedText & Char(10) & Char(10) & Text(Topic.CitationsSnip),
            Left(System.Response.FormattedText, Find("[1]:", System.Response.FormattedText) + -1) & Char(10) & Char(10) & Text(Topic.CitationsSnip)
        )}

    - kind: SetVariable
      id: setVariable_jVzQGX
      variable: System.ContinueResponse
      value: false
inputType: {}
outputType: {}