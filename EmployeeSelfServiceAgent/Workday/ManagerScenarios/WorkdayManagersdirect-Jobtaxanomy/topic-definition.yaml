kind: AdaptiveDialog
modelDescription: |-
  You will respond to requests about the job function of direct reports of the user making the request. Your information is retrieved from Workday, and will only contain results regarding the user's direct reports. There is no information available for anyone who isn't a direct report, and being a direct report means that the individual is not a manager, spouse, sibling, or any other relationship to the requestor, and only means that they report to the requestor. The resulting data will contain a list of employees who report to the requestor and will contain their job function data. You must NOT give data if you do not have enough info.
  
  Example invalid requests:
  "What is my manager's job function?"
  "What is my sister's job title?"
  
  Example valid requests:
  "What is the external title of my direct reports?"
  "What is [EmployeeName]'s job title?"
  
  Your output **must** be a nested list in markdown language based on the data contained in the {Topic.workdayResponseTable} variable.
inputs:
  - kind: AutomaticTaskInput
    propertyName: EmployeeName
    description: Employee name whose job data needs to be retrieved
    entity: PersonNamePrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - Show me my team's job title?
      - What is the internal title of my direct report X?
      - What is the job function of my team?
      - What job profile is mapped to my team members?
      - What are the external titles of my team members?
      - What is the internal title of my direct report [EmployeeName]?
      - Show me my team's job taxonomy?
      - What is the job function of my team?
      - What job profile is mapped to my team members?
      - What are the external titles of my team members?
      - Get job data for [EmployeeName].
      - What is the job title of [EmployeeName]?

  actions:
    - kind: BeginDialog
      id: Y8gqWh
      displayName: Check manager status
      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdayManagerCheck

    - kind: BeginDialog
      id: 7Va4UU
      displayName: Redirect to Workday Get Common Execution
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{ManagerOrgId}"",""value"":""" & Global.ESS_UserContext_ManagerOrganizationId & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Today(), "yyyy-MM-dd") &"""}]}"
          scenarioName: msdyn_HRWorkdayHCMManagerJobTaxonomy

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ParseValue
      id: mq6jr0
      displayName: Parse workdayResponse into table
      variable: Topic.WorkdayResponseRecord
      valueType:
        kind: Record
        properties:
          BusinessTitle:
            type:
              kind: Table
              properties:
                Value: String

          FirstName:
            type:
              kind: Table
              properties:
                Value: String

          JobFamilyId:
            type:
              kind: Table
              properties:
                Value: String

          JobProfile:
            type:
              kind: Table
              properties:
                Value: String

          JobTitle:
            type:
              kind: Table
              properties:
                Value: String

          LastName:
            type:
              kind: Table
              properties:
                Value: String

          WorkerID:
            type:
              kind: Table
              properties:
                Value: String

      value: =Topic.workdayResponse

    - kind: BeginDialog
      id: QdE53O
      displayName: Refresh JobFamily reference data
      input:
        binding:
          IsTableEmpty: =IsBlank(Global.JobFamilyLookupTable)
          ReferenceDataKey: Job_Family_ID

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemRefreshReferenceData

    - kind: SetVariable
      id: setVariable_EFFdlM
      displayName: Merge all records in table
      variable: Topic.workdayResponseTable
      value: |-
        =ForAll(
            Sequence(CountRows(Topic.WorkdayResponseRecord.WorkerID)),
            {
                FirstName: Last(FirstN(Topic.WorkdayResponseRecord.FirstName, Value)).Value,
                LastName: Last(FirstN(Topic.WorkdayResponseRecord.LastName, Value)).Value,
                JobTitle: Last(FirstN(Topic.WorkdayResponseRecord.JobTitle, Value)).Value,
                BusinessTitle: Last(FirstN(Topic.WorkdayResponseRecord.BusinessTitle, Value)).Value,
                JobProfile: Last(FirstN(Topic.WorkdayResponseRecord.JobProfile, Value)).Value,
                JobFamily: LookUp(Global.JobFamilyLookupTable,
                            ID = Last(FirstN(Topic.WorkdayResponseRecord.JobFamilyId, Value)).Value
                        ).Referenced_Object_Descriptor
            }
        )

    - kind: ConditionGroup
      id: conditionGroup_yepfHF
      conditions:
        - id: conditionItem_86c1ij
          condition: =!IsBlank(Topic.EmployeeName)
          displayName: Check if EmployeeName provided
          actions:
            - kind: SetVariable
              id: setVariable_z1fKB1
              displayName: Filter for the given EmployeeName
              variable: Topic.workdayResponseTable
              value: |
                =Filter(
                    Topic.workdayResponseTable,
                    FirstName = Topic.EmployeeName Or 
                    LastName = Topic.EmployeeName Or 
                    Concatenate(FirstName, " ", LastName) = Topic.EmployeeName Or 
                    Concatenate(LastName, " ", FirstName) = Topic.EmployeeName
                )

            - kind: ConditionGroup
              id: conditionGroup_BVYTlV
              conditions:
                - id: conditionItem_QmVzq2
                  condition: =IsEmpty(Topic.workdayResponseTable)
                  displayName: Check is filtered data empty
                  actions:
                    - kind: SendActivity
                      id: sendActivity_m8xRtz
                      displayName: Respond with no access message
                      activity: It looks like you don't have access to this information. Try making a new request.

                    - kind: SetVariable
                      id: setVariable_wd0UBE
                      displayName: Clear workday response
                      variable: Topic.workdayResponse
                      value: =""

                    - kind: EndDialog
                      id: xa93ze

inputType:
  properties:
    EmployeeName:
      displayName: EmployeeName
      description: Employee name whose job data needs to be retrieved
      type: String

outputType:
  properties:
    workdayResponseTable:
      displayName: workdayResponseTable
      type:
        kind: Table
        properties:
          BusinessTitle: String
          FirstName: String
          JobFamily: String
          JobProfile: String
          JobTitle: String
          LastName: String