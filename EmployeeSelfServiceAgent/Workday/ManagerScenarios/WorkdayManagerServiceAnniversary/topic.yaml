kind: AdaptiveDialog
modelDescription: |-
  You will respond to requests about the service anniversary of direct reports of the user making the request. Your information is retrieved from Workday, and will only contain results regarding the user's direct reports. There is no information available for anyone who isn't a direct report. The resulting data will contain a list of employees who report to the requestor and will contain their service anniversary data. You must NOT give data if you do not have enough info.
  
  Ex. invalid requests:
  "What is my manager's service anniversary?"
  "What is my sister's hire date?"
  
  Ex. valid requests:
  "What is the service anniversary of my direct reports?"
  
  If question contains "next month" use isAnniversaryNextMonth to filter. Unless specified, the response should always be future anniversaries. Include the following columns in your response Employee Name, Hire Date, Upcoming Service Anniversary Date, Upcoming Milestone
  Your output **must** be a table in markdown language and **must** be based on {Topic.response}.
inputs:
  - kind: AutomaticTaskInput
    propertyName: EmployeeName
    description: Employee name whose service anniversary needs to be retrieved
    entity: PersonNamePrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

  - kind: AutomaticTaskInput
    propertyName: duration
    description: Duration used to calculate nth service anniversary date
    entity: NumberPrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - When are the service anniversaries of all my directs?
      - What are the service anniversaries of my entire team?
      - Show me the service anniversaries of my reports?
      - What are the upcoming service anniversaries of my team?
      - Any upcoming service anniversaries of my reports?
      - Show me service anniversaries of my directs?
      - What is [EmployeeName]'s next service anniversary?
      - When is [EmployeeName]'s next year service anniversary?

  actions:
    - kind: BeginDialog
      id: WmAHrc
      displayName: Check manager criteria
      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdayManagerCheck

    - kind: SetVariable
      id: setVariable_FrkyzI
      displayName: Set current date
      variable: Topic.currentDate
      value: =Now()

    - kind: BeginDialog
      id: HZDypL
      displayName: Redirect to Workday Get Common Execution
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{ManagerOrgId}"",""value"":""" & Global.ESS_UserContext_ManagerOrganizationId & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Today(), "yyyy-MM-dd") &"""}]}"
          scenarioName: msdyn_HRWorkdayHCMManagerServiceAnniversary

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ParseValue
      id: Nh88X0
      displayName: Parse Workday response
      variable: Topic.parsedWorkdayResponse
      valueType:
        kind: Record
        properties:
          FirstName:
            type:
              kind: Table
              properties:
                Value: String

          HireDate:
            type:
              kind: Table
              properties:
                Value: String

          LastName:
            type:
              kind: Table
              properties:
                Value: String

          WorkerID:
            type:
              kind: Table
              properties:
                Value: String

      value: =Topic.workdayResponse

    - kind: SetVariable
      id: setVariable_eJUuES
      displayName: Build Workday response table
      variable: Topic.workdayResponseTable
      value: |-
        =ForAll(
                    Sequence(CountRows(Topic.parsedWorkdayResponse.WorkerID)),
                    {
                        FirstName: Last(FirstN(Topic.parsedWorkdayResponse.FirstName, Value)).Value,
                        LastName: Last(FirstN(Topic.parsedWorkdayResponse.LastName, Value)).Value,
                        HireDate: Last(FirstN(Topic.parsedWorkdayResponse.HireDate, Value)).Value
                    }
                )

    - kind: ConditionGroup
      id: conditionGroup_P6QlNE
      conditions:
        - id: conditionItem_3RSvtM
          condition: =!IsBlank(Topic.EmployeeName)
          displayName: Check if EmployeeName provided
          actions:
            - kind: SetVariable
              id: setVariable_yRTs4g
              displayName: Filter for the given EmployeeName
              variable: Topic.workdayResponseTable
              value: |-
                =Filter(
                    Topic.workdayResponseTable,
                        FirstName = Topic.EmployeeName Or 
                        LastName = Topic.EmployeeName Or 
                        Concatenate(FirstName, " ", LastName) = Topic.EmployeeName Or 
                        Concatenate(LastName, " ", FirstName) = Topic.EmployeeName
                    )

            - kind: ConditionGroup
              id: conditionGroup_5aSdys
              conditions:
                - id: conditionItem_U6JgqP
                  condition: =IsEmpty(Topic.workdayResponseTable)
                  displayName: Check is filtered data empty
                  actions:
                    - kind: SendActivity
                      id: sendActivity_ToPxHZ
                      displayName: Respond with no access message
                      activity: It looks like you don't have access to this information. Try making a new request.

                    - kind: SetVariable
                      id: setVariable_bqlpWp
                      displayName: Clear response table
                      variable: Topic.workdayResponseTable
                      value: =[]

                    - kind: CancelAllDialogs
                      id: PsP6gr

    - kind: SetVariable
      id: setVariable_CxBy4Y
      displayName: Set response to formatted Workday response
      variable: Topic.response
      value: |-
        =ForAll(Topic.workdayResponseTable, {
          EmployeeName: 'FirstName' & " " & 'LastName',
          HireDate: DateValue('HireDate'),
          UpcomingServiceAnniversaryDate: If(
            Today() <= DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years) + 1, TimeUnit.Years)
          ),
          UpcomingMilestone: DateDiff(DateValue('HireDate'), If(
            Today() <= DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years) + 1, TimeUnit.Years)
          ), TimeUnit.Years),
          AnniversaryMonth: Month(If(
            Today() <= DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years) + 1, TimeUnit.Years)
          )),
          isAnniversaryNextMonth: Month(If(
            Today() <= DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years), TimeUnit.Years),
            DateAdd(DateValue('HireDate'), DateDiff(DateValue('HireDate'), Today(), TimeUnit.Years) + 1, TimeUnit.Years)
          )) = Month(Now()) + 1
        })

    - kind: SetVariable
      id: setVariable_AnybBj
      displayName: Clear workday response
      variable: Topic.workdayResponse
      value: "\"\""

    - kind: EndDialog
      id: Y2VqKn

inputType:
  properties:
    duration:
      displayName: duration
      description: Duration used to calculate nth service anniversary date
      type: Number

    EmployeeName:
      displayName: EmployeeName
      description: Employee name whose service anniversary needs to be retrieved
      type: String

outputType:
  properties:
    response:
      displayName: response
      type:
        kind: Table
        properties:
          AnniversaryMonth: Number
          EmployeeName: String
          HireDate: Date
          isAnniversaryNextMonth: Boolean
          UpcomingMilestone: Number
          UpcomingServiceAnniversaryDate: Date