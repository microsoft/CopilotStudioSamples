kind: AdaptiveDialog
modelDescription: |-
  You will respond to requests about the contact information of the user making the request. This data is retrieved from Workday. You will respond to the user based on which piece of data they are asking for. This data exclusively belongs to the user making the request. There is no data for anyone else. Do not respond to questions about other people's data. "Home" and "Personal" data are synonymous.
  
  Example invalid requests:
  "What is my manager's contact information?"
  "What is my sister's contact information?"
  
  Example valid requests:
  "What is my contact information?"
inputs:
  - kind: AutomaticTaskInput
    propertyName: EmployeeName
    description: The name of the employee whose data will be fetched
    entity: PersonNamePrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - Show my Contact details? 
      - What is my Work Phone? 
      - What is my Work Email? 
      - What is my Work Address? 
      - Show my Work Contact information? 
      - Show my Personal Phone number? 
      - What is my Home Phone number? 
      - Show my Home Email? 
      - Can you tell me what my Personal Email is ? 
      - Which Personal email is registered as primary? 
      - Show my Home address? 
      - Show my Personal Contact Information? 
      - Show [EmployeeName]'s contact info

  actions:
    - kind: BeginDialog
      id: uzpKxp
      displayName: Check user access
      input:
        binding:
          EmployeeName: =Topic.EmployeeName

      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemAccessCheck

    - kind: BeginDialog
      id: Z6efSa
      displayName: Fetch Work Contact Information from Workday
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Today(), "yyyy-MM-dd") &"""}]}"
          scenarioName: ="msdyn_HRWorkdayHCMEmployeeGetWorkContactInformation"

      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ParseValue
      id: b90ZAp
      displayName: Parse Work Contact data
      variable: Topic.workContactData
      valueType:
        kind: Record
        properties:
          EmailInformation:
            type:
              kind: Table
              properties:
                Email_Data:
                  type:
                    kind: Record
                    properties:
                      Email_Address: String

                Email_ID: String
                Email_Reference:
                  type:
                    kind: Record
                    properties:
                      @Descriptor: String
                      ID:
                        type:
                          kind: Table
                          properties:
                            @type: String
                            "#text": String

                Usage_Data:
                  type:
                    kind: Record
                    properties:
                      @Public: String
                      Type_Data:
                        type:
                          kind: Record
                          properties:
                            @Primary: String
                            Type_Reference:
                              type:
                                kind: Record
                                properties:
                                  @Descriptor: String
                                  ID:
                                    type:
                                      kind: Table
                                      properties:
                                        @type: String
                                        "#text": String

          PhoneInformation:
            type:
              kind: Table
              properties:
                Phone_Data:
                  type:
                    kind: Record
                    properties:
                      @Formatted_Phone: String
                      Complete_Phone_Number: String
                      Country_Code_Reference:
                        type:
                          kind: Record
                          properties:
                            @Descriptor: String
                            ID:
                              type:
                                kind: Table
                                properties:
                                  @type: String
                                  "#text": String

                      Device_Type_Reference:
                        type:
                          kind: Record
                          properties:
                            @Descriptor: String
                            ID:
                              type:
                                kind: Table
                                properties:
                                  @type: String
                                  "#text": String

                Phone_ID: String
                Phone_Reference:
                  type:
                    kind: Record
                    properties:
                      @Descriptor: String
                      ID:
                        type:
                          kind: Table
                          properties:
                            @type: String
                            "#text": String

                Usage_Data:
                  type:
                    kind: Table
                    properties:
                      @Public: String
                      Type_Data:
                        type:
                          kind: Record
                          properties:
                            @Primary: String
                            Type_Reference:
                              type:
                                kind: Record
                                properties:
                                  @Descriptor: String
                                  ID:
                                    type:
                                      kind: Table
                                      properties:
                                        @type: String
                                        "#text": String

      value: =Topic.workdayResponse

    - kind: BeginDialog
      id: tZ3bkQ
      displayName: Fetch Home Contact Information from Workday
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Today(), "yyyy-MM-dd") &"""}]}"
          scenarioName: msdyn_HRWorkdayHCMEmployeeGetHomeContactInformation

      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ParseValue
      id: D15SKZ
      displayName: Parse Home Contact data
      variable: Topic.homeContactData
      valueType:
        kind: Record
        properties:
          EmailInformation:
            type:
              kind: Table
              properties:
                Email_Data:
                  type:
                    kind: Record
                    properties:
                      Email_Address: String
                      Email_Comment: String

                Email_ID: String
                Email_Reference:
                  type:
                    kind: Record
                    properties:
                      @Descriptor: String
                      ID:
                        type:
                          kind: Table
                          properties:
                            @type: String
                            "#text": String

                Usage_Data:
                  type:
                    kind: Record
                    properties:
                      @Public: String
                      Type_Data:
                        type:
                          kind: Record
                          properties:
                            @Primary: String
                            Type_Reference:
                              type:
                                kind: Record
                                properties:
                                  @Descriptor: String
                                  ID:
                                    type:
                                      kind: Table
                                      properties:
                                        @type: String
                                        "#text": String

          HomeAddress:
            type:
              kind: Table
              properties:
                Value: String

          PhoneInformation:
            type:
              kind: Table
              properties:
                Phone_Data:
                  type:
                    kind: Record
                    properties:
                      @Formatted_Phone: String
                      Complete_Phone_Number: String
                      Country_Code_Reference:
                        type:
                          kind: Record
                          properties:
                            @Descriptor: String
                            ID:
                              type:
                                kind: Table
                                properties:
                                  @type: String
                                  "#text": String

                      Device_Type_Reference:
                        type:
                          kind: Record
                          properties:
                            @Descriptor: String
                            ID:
                              type:
                                kind: Table
                                properties:
                                  @type: String
                                  "#text": String

                Phone_ID: String
                Phone_Reference:
                  type:
                    kind: Record
                    properties:
                      @Descriptor: String
                      ID:
                        type:
                          kind: Table
                          properties:
                            @type: String
                            "#text": String

                Usage_Data:
                  type:
                    kind: Table
                    properties:
                      @Public: String
                      Type_Data:
                        type:
                          kind: Record
                          properties:
                            @Primary: String
                            Type_Reference:
                              type:
                                kind: Record
                                properties:
                                  @Descriptor: String
                                  ID:
                                    type:
                                      kind: Table
                                      properties:
                                        @type: String
                                        "#text": String

      value: =Topic.workdayResponse

    - kind: BeginDialog
      id: p2xAZU
      displayName: Fetch Work Address
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Today(), "yyyy-MM-dd") &"""}]}"
          scenarioName: msdyn_HRWorkdayHCMEmployeeGetWorkAddress

      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ParseValue
      id: 3IdZeI
      displayName: Parse Work Address
      variable: Topic.workAddress
      valueType:
        kind: Record
        properties:
          WorkAddress:
            type:
              kind: Table
              properties:
                Value: String

      value: =Topic.workdayResponse

    - kind: SetVariable
      id: setVariable_LXnWnT
      displayName: Set final data
      variable: Topic.finalizedContactInformation
      value: |-
        ={
            employeeName: Global.ESS_UserContext_Employee_Firstname & " " & Global.ESS_UserContext_Employee_Lastname,
            workPhoneNumbers:ForAll(Topic.workContactData.PhoneInformation, {PhoneNumber: ThisRecord.Phone_Data.'@Formatted_Phone',IsPrimaryPhoneNumber: CountIf(ThisRecord.Usage_Data,Type_Data.'@Primary' = "1") > 0}),
            workEmails:ForAll(Topic.workContactData.EmailInformation, {EmailAddress: ThisRecord.Email_Data.Email_Address, IsPrimaryEmailAddress:ThisRecord.Usage_Data.Type_Data.'@Primary'}),
            workAddress: First(Topic.workAddress.WorkAddress).Value,
            homePhoneNumbers: ForAll(Topic.homeContactData.PhoneInformation, {PhoneNumber: ThisRecord.Phone_Data.'@Formatted_Phone',IsPrimaryPhoneNumber: CountIf(ThisRecord.Usage_Data,Type_Data.'@Primary' = "1") > 0}),
            homeEmails:ForAll(Topic.homeContactData.EmailInformation, {EmailAddress: ThisRecord.Email_Data.Email_Address, IsPrimaryEmailAddress:ThisRecord.Usage_Data.Type_Data.'@Primary'}),
            homeAddress:First(Topic.homeContactData.HomeAddress).Value
        }

inputType:
  properties:
    EmployeeName:
      displayName: EmployeeName
      description: The name of the employee whose data will be fetched
      type: String

outputType:
  properties:
    finalizedContactInformation:
      displayName: finalizedContactInformation
      type:
        kind: Record
        properties:
          employeeName: String
          homeAddress: String
          homeEmails:
            type:
              kind: Table
              properties:
                EmailAddress: String
                IsPrimaryEmailAddress: String

          homePhoneNumbers:
            type:
              kind: Table
              properties:
                IsPrimaryPhoneNumber: Boolean
                PhoneNumber: String

          workAddress: String
          workEmails:
            type:
              kind: Table
              properties:
                EmailAddress: String
                IsPrimaryEmailAddress: String

          workPhoneNumbers:
            type:
              kind: Table
              properties:
                IsPrimaryPhoneNumber: Boolean
                PhoneNumber: String