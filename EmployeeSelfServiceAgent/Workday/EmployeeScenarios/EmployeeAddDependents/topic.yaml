kind: AdaptiveDialog
modelDescription: |-
  You will respond only to requests related to adding or managing dependents for the user making the request.
  Dependents include spouses, domestic partners, children, and other family members who may be covered under employee benefits.
  All dependent data is retrieved from and submitted to Workday, and pertains exclusively to the requesting user.
  This data exclusively belongs to the user making the request. Do not respond to questions about other people's data.
    
  Example invalid requests:
  "Add a dependent for my manager"
  "Update dependents for [EmployeeName]"
  "Show dependents for my colleague"
    
  Example valid requests:
  "Add a dependent"
  "I want to add my child as a dependent"
  "Add my spouse to my benefits"
  "Register a new dependent"
  "I need to add a family member"

beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent: {}

  actions:
    # Set Workday icon URL
    - kind: SetVariable
      id: set_workday_icon_url
      variable: Topic.WorkdayIconUrl
      value: data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=

    # Step 1: Fetch reference data for relationship types
    - kind: ConditionGroup
      id: checkRelationshipTypes
      conditions:
        - id: relationshipTypesUninitialized
          condition: =IsBlank(Global.RelatedPersonRelationshipLookupTable)
          displayName: If relationship type picklist is uninitialized
          actions:
            - kind: BeginDialog
              id: fetchRelationshipTypes
              displayName: Redirect to Workday System Get Reference Data
              input:
                binding:
                  referenceDataKey: Related_Person_Relationship_ID
              dialog: msdyn_copilotforemployeeselfservicehr.topic.GetReferenceData

    # Step 2: Fetch existing dependents
    - kind: BeginDialog
      id: getDependents_BeginDialog
      displayName: Get Current Dependents
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Now(), "yyyy-MM-dd") &"""}]}"
          scenarioName: msdyn_HRWorkdayHCMEmployeeGetDependents
      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ConditionGroup
      id: checkGetSuccess
      conditions:
        - id: getSuccessCondition
          condition: =Topic.isSuccess = false
          actions:
            - kind: SendActivity
              id: sendErrorMessage
              activity: I encountered an error retrieving your dependent information. Please try again later or contact support.
            - kind: EndDialog
              id: endOnError

    # Step 3: Parse the response
    - kind: ParseValue
      id: parseDependentsResponse
      displayName: Parse dependents response
      variable: Topic.dependentsRecord
      valueType:
        kind: Record
        properties:
          DependentID:
            type:
              kind: Table
              properties:
                Value: String
          DependentWID:
            type:
              kind: Table
              properties:
                Value: String
          PersonWID:
            type:
              kind: Table
              properties:
                Value: String
          FullName:
            type:
              kind: Table
              properties:
                Value: String
          FirstName:
            type:
              kind: Table
              properties:
                Value: String
          LastName:
            type:
              kind: Table
              properties:
                Value: String
          DateOfBirth:
            type:
              kind: Table
              properties:
                Value: String
          Gender:
            type:
              kind: Table
              properties:
                Value: String
          RelationshipTypeID:
            type:
              kind: Table
              properties:
                Value: String
          IsFullTimeStudent:
            type:
              kind: Table
              properties:
                Value: String
          IsDisabled:
            type:
              kind: Table
              properties:
                Value: String
      value: =Topic.workdayResponse

    # Step 4: Transform to table (XPath already filters to only actual dependents)
    - kind: SetVariable
      id: setVariable_transformDependents
      displayName: Transform dependents to table
      variable: Topic.dependentsTable
      value: |-
        =ForAll(
            Sequence(CountRows(Topic.dependentsRecord.DependentID)),
            {
                DependentID: Last(FirstN(Topic.dependentsRecord.DependentID, Value)).Value,
                DependentWID: Last(FirstN(Topic.dependentsRecord.DependentWID, Value)).Value,
                PersonWID: Last(FirstN(Topic.dependentsRecord.PersonWID, Value)).Value,
                FullName: Last(FirstN(Topic.dependentsRecord.FullName, Value)).Value,
                FirstName: Last(FirstN(Topic.dependentsRecord.FirstName, Value)).Value,
                LastName: Last(FirstN(Topic.dependentsRecord.LastName, Value)).Value,
                DateOfBirth: Last(FirstN(Topic.dependentsRecord.DateOfBirth, Value)).Value,
                Gender: Last(FirstN(Topic.dependentsRecord.Gender, Value)).Value,
                RelationshipType: LookUp(Global.RelatedPersonRelationshipLookupTable, ID = Last(FirstN(Topic.dependentsRecord.RelationshipTypeID, Value)).Value).Referenced_Object_Descriptor,
                RelationshipTypeID: Last(FirstN(Topic.dependentsRecord.RelationshipTypeID, Value)).Value,
                IsFullTimeStudent: Last(FirstN(Topic.dependentsRecord.IsFullTimeStudent, Value)).Value = "1",
                IsDisabled: Last(FirstN(Topic.dependentsRecord.IsDisabled, Value)).Value = "1"
            }
        )

    # Step 5: Show existing dependents and option to add new
    - kind: ConditionGroup
      id: checkExistingDependents
      conditions:
        - id: hasDependentsCondition
          condition: =CountRows(Topic.dependentsTable) > 0
          actions:
            - kind: SendActivity
              id: sendExistingDependentsMsg
              activity: |-
                You currently have **{CountRows(Topic.dependentsTable)}** dependent(s) on file:
                
                {Concat(Topic.dependentsTable, "• " & FullName & " (" & RelationshipType & ")" & Char(10))}
                
                Let's add a new dependent.

      elseActions:
        - kind: SendActivity
          id: sendNoDependentsMsg
          activity: You don't have any dependents on file yet. Let's add one now.

    # Step 6: Collect dependent information using Adaptive Card
    - kind: AdaptiveCardPrompt
      id: collectDependentCard
      displayName: Collect dependent information
      card: |-
        ={
            type: "AdaptiveCard",
            '$schema': "http://adaptivecards.io/schemas/adaptive-card.json",
            version: "1.5",
            body: [
                {
                    type: "ColumnSet",
                    columns: [
                        {
                            type: "Column",
                            width: "auto",
                            items: [
                                {
                                    type: "Image",
                                    url: Topic.WorkdayIconUrl,
                                    style: "RoundedCorners",
                                    size: "Small",
                                    height: "20px",
                                    width: "20px"
                                }
                            ],
                            verticalContentAlignment: "Center"
                        },
                        {
                            type: "Column",
                            width: "auto",
                            items: [
                                {
                                    type: "TextBlock",
                                    text: "",
                                    size: "Small",
                                    weight: "Bolder"
                                }
                            ],
                            verticalContentAlignment: "Center",
                            spacing: "Small"
                        }
                    ]
                },
                {
                    type: "TextBlock",
                    text: "Add a new dependent",
                    weight: "Bolder",
                    size: "Medium",
                    wrap: true,
                    spacing: "Medium"
                },
                {
                    type: "TextBlock",
                    text: "Fields marked with * are required.",
                    wrap: true,
                    size: "Small",
                    spacing: "Small"
                },
                {
                    type: "Input.Text",
                    id: "firstName",
                    label: "First name",
                    placeholder: "Enter first name",
                    isRequired: true,
                    errorMessage: "First name is required."
                },
                {
                    type: "Input.Text",
                    id: "lastName",
                    label: "Last name",
                    placeholder: "Enter last name",
                    isRequired: true,
                    errorMessage: "Last name is required."
                },
                {
                    type: "Input.Date",
                    id: "dateOfBirth",
                    label: "Date of birth",
                    isRequired: true,
                    errorMessage: "Date of birth is required."
                },
                {
                    type: "Input.ChoiceSet",
                    id: "gender",
                    label: "Gender",
                    style: "compact",
                    isRequired: true,
                    errorMessage: "Please select a gender.",
                    placeholder: "Select gender",
                    choices: [
                        { title: "Male", value: "Male" },
                        { title: "Female", value: "Female" },
                        { title: "Not declared", value: "Not_Declared" }
                    ]
                },
                {
                    type: "Input.ChoiceSet",
                    id: "relationshipType",
                    label: "Relationship to employee",
                    style: "compact",
                    isRequired: true,
                    errorMessage: "Please select a relationship.",
                    placeholder: "Select relationship",
                    choices: ForAll(Global.RelatedPersonRelationshipLookupTable, { title: ThisRecord.Referenced_Object_Descriptor, value: ThisRecord.ID })
                },
                {
                    type: "Input.ChoiceSet",
                    id: "country",
                    label: "Country",
                    style: "compact",
                    isRequired: true,
                    errorMessage: "Please select a country.",
                    value: "USA",
                    choices: [
                        { title: "United States", value: "USA" },
                        { title: "Canada", value: "CAN" },
                        { title: "United Kingdom", value: "GBR" },
                        { title: "India", value: "IND" },
                        { title: "Australia", value: "AUS" },
                        { title: "Germany", value: "DEU" },
                        { title: "France", value: "FRA" }
                    ]
                }
            ],
            actions: [
                { type: "Action.Submit", title: "Submit", id: "Submit", data: { actionSubmitId: "Submit" } },
                { type: "Action.Submit", title: "Cancel", id: "Cancel", data: { actionSubmitId: "Cancel" }, associatedInputs: "none" }
            ]
        }
      output:
        binding:
          actionSubmitId: Topic.formActionId
          firstName: Topic.firstName
          lastName: Topic.lastName
          dateOfBirth: Topic.dateOfBirth
          gender: Topic.gender
          relationshipType: Topic.relationshipType
          country: Topic.country
      outputType:
        properties:
          actionSubmitId: String
          firstName: String
          lastName: String
          dateOfBirth: String
          gender: String
          relationshipType: String
          country: String

    # Step 7: Handle cancel
    - kind: ConditionGroup
      id: checkCancelAction
      conditions:
        - id: cancelCondition
          condition: =Topic.formActionId = "Cancel"
          actions:
            - kind: SendActivity
              id: sendCancelMessage
              activity: Request cancelled. No dependent was added. Is there anything else I can help you with?
            - kind: CancelAllDialogs
              id: cancelAll

    # Step 8: Validate required fields
    - kind: ConditionGroup
      id: validateFields
      conditions:
        - id: missingFieldsCondition
          condition: =IsBlank(Topic.firstName) || IsBlank(Topic.lastName) || IsBlank(Topic.dateOfBirth) || IsBlank(Topic.gender) || IsBlank(Topic.relationshipType) || IsBlank(Topic.country)
          actions:
            - kind: SendActivity
              id: sendValidationError
              activity: Please fill in all required fields (first name, last name, date of birth, gender, relationship, and country).
            - kind: EndDialog
              id: endOnValidationError

    # Step 9: Set relationship type ID (already comes from lookup table)
    - kind: SetVariable
      id: mapRelationshipType
      displayName: Set relationship type ID
      variable: Topic.relationshipTypeId
      value: =Topic.relationshipType

    # Step 10: Call Add Dependent API
    - kind: BeginDialog
      id: addDependent_BeginDialog
      displayName: Add Dependent to Workday
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{First_Name}"",""value"":""" & Topic.firstName & """},{""key"":""{Last_Name}"",""value"":""" & Topic.lastName & """},{""key"":""{Date_Of_Birth}"",""value"":""" & Topic.dateOfBirth & """},{""key"":""{Gender}"",""value"":""" & Topic.gender & """},{""key"":""{Relationship_Type}"",""value"":""" & Topic.relationshipTypeId & """},{""key"":""{Country_Code}"",""value"":""" & Topic.country & """}]}"
          scenarioName: msdyn_HRWorkdayHCMEmployeeAddDependent
      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.addErrorResponse
          isSuccess: Topic.addIsSuccess
          workdayResponse: Topic.addWorkdayResponse

    # Step 11: Show result
    - kind: ConditionGroup
      id: checkAddSuccess
      conditions:
        - id: addSuccessCondition
          condition: =Topic.addIsSuccess = true
          actions:
            - kind: SendActivity
              id: sendSuccessIntroMessage
              activity: Great! You've added a new dependent.

            - kind: SetVariable
              id: setOtherDependentsList
              variable: Topic.otherDependentsList
              value: =If(CountRows(Topic.dependentsTable) > 0, Concat(Topic.dependentsTable, FullName, ", "), "None")

            - kind: SendActivity
              id: sendSuccessMessage
              activity:
                attachments:
                  - kind: AdaptiveCardTemplate
                    cardContent: |-
                      ={
                        type: "AdaptiveCard",
                        '$schema': "http://adaptivecards.io/schemas/adaptive-card.json",
                        version: "1.5",
                        body: [
                          {
                            type: "ColumnSet",
                            columns: [
                              {
                                type: "Column",
                                width: "auto",
                                items: [
                                  {
                                    type: "Image",
                                    url: Topic.WorkdayIconUrl,
                                    style: "RoundedCorners",
                                    size: "Small",
                                    height: "20px",
                                    width: "20px"
                                  }
                                ],
                                verticalContentAlignment: "Center"
                              },
                              {
                                type: "Column",
                                width: "auto",
                                items: [
                                  {
                                    type: "TextBlock",
                                    text: "",
                                    size: "Small",
                                    weight: "Bolder"
                                  }
                                ],
                                verticalContentAlignment: "Center",
                                spacing: "Small"
                              }
                            ]
                          },
                          {
                            type: "TextBlock",
                            text: "✅ Your new dependent was added",
                            weight: "Bolder",
                            size: "Medium",
                            wrap: true,
                            spacing: "Medium"
                          },
                          {
                            type: "FactSet",
                            spacing: "Medium",
                            facts: [
                              { title: "Name", value: Topic.firstName & " " & Topic.lastName },
                              { title: "Date of birth", value: Topic.dateOfBirth },
                              { title: "Gender", value: Topic.gender },
                              { title: "Relationship to employee", value: LookUp(Global.RelatedPersonRelationshipLookupTable, ID = Topic.relationshipType).Referenced_Object_Descriptor },
                              { title: "Other dependents", value: Topic.otherDependentsList }
                            ]
                          }
                        ]
                      }

            - kind: CancelAllDialogs
              id: endOnSuccess

      elseActions:
        - kind: SendActivity
          id: sendAddErrorMessage
          activity: |-
            There was an error adding the dependent. Please try again later or contact HR support.
            
            **Error details:** {Topic.addErrorResponse}

        - kind: CancelAllDialogs
          id: endOnError2

inputType: {}
outputType:
  properties:
    addIsSuccess:
      displayName: Add Success
      type: Boolean
