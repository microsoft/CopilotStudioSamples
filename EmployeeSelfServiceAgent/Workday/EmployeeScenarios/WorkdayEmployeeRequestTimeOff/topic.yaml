kind: AdaptiveDialog
modelDescription: |
  - You will respond only to requests related to submitting a Time Off entry for the user making the request.
  - All time off data is retrieved from and updated through Workday, and pertains exclusively to the requesting user.
  - This topic may prompt the user for input if they are requesting to submit time off for themselves.
  - Do not respond to questions about other people's data.

  Example valid requests:
  "Request 8 hours vacation on 2025-09-15"
  "Take a floating holiday next Friday for 8 hours"
  "PTO duty on 2025-09-08, 4 hours, add a note 'personal work'"

  Example invalid requests:
  "Submit time off for my manager"
  "Enter vacation for [EmployeeName]"
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent: {}
  actions:
    - kind: BeginDialog
      id: access_check
      displayName: Verify access for requested name
      input:
        binding:
          EmployeeName: =Topic.EmployeeName

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemAccessCheck

    - kind: SetVariable
      id: set_website_message
      variable: Topic.WebsiteMessage
      value: =Env.WorkdayWebsiteRedirectMessage

    - kind: SetVariable
      id: setDefaultHours
      variable: Topic.hours
      value: =If(IsBlank(Topic.hours), 8, Topic.hours)

    - kind: AdaptiveCardPrompt
      id: requestTimeOffCard
      displayName: Request Time Off
      card: |-
        {
          "type": "AdaptiveCard",
          "$schema": "https://adaptivecards.io/schemas/adaptive-card.json",
          "version": "1.5",
          "body": [
            {
              "type": "TextBlock",
              "text": "Request to take Time Off",
              "weight": "Bolder",
              "size": "Medium",
              "wrap": true,
              "color": "Accent"
            },
            {
              "type": "TextBlock",
              "text": "Fill out the details below. Fields may be pre-filled from your request.",
              "wrap": true
            },
            {
              "type": "Input.Date",
              "id": "timeOffDate",
              "label": "Date",
              "isRequired": true,
              "errorMessage": "Please select a date"
            },
            {
              "type": "Input.Number",
              "id": "hours",
              "label": "Number of Hours",
              "min": 0.5,
              "max": 24
            },
            {
              "type": "Input.ChoiceSet",
              "id": "reason",
              "label": "Reason",
              "isRequired": true,
              "errorMessage": "Please choose a reason",
              "choices": [
                {
                  "title": "Vacation",
                  "value": "Vacation_Hours"
                },
                {
                  "title": "Floating Holiday",
                  "value": "Floating_Holiday_Hours"
                },
                {
                  "title": "Paid Leave",
                  "value": "Paid_Time_Off_Adjustment_Hours"
                }
              ],
              "value": "=If(!IsBlank(Topic.reason), Topic.reason, \"\")"
            },
            {
              "type": "Input.Text",
              "id": "comment",
              "label": "Comment",
              "isMultiline": true,
              "placeholder": "Optional note for your approver"
            }
          ],
          "actions": [
            {
              "type": "Action.Submit",
              "title": "Submit",
              "data": {
                "actionId": "Submit"
              }
            },
            {
              "type": "Action.Submit",
              "title": "Cancel",
              "associatedInputs": "none",
              "data": {
                "actionId": "Cancel"
              }
            }
          ]
        }
      output:
        binding:
          actionId: Topic.actionId
          comment: Topic.comment
          hours: Topic.hours
          reason: Topic.reason
          timeOffDate: Topic.timeOffDate

      outputType:
        properties:
          actionId: String
          comment: String
          hours: Number
          reason: String
          timeOffDate: DateTime

    - kind: ConditionGroup
      id: handleCancel
      conditions:
        - id: isCancel
          condition: =Topic.actionId = "Cancel"
          actions:
            - kind: SendActivity
              id: cancelMsg
              activity: Your request has been cancelled. Is there anything else you need help with?

            - kind: CancelAllDialogs
              id: cancelAllOnCancel

    - kind: SetVariable
      id: mapReasonTitle
      variable: Topic.reasonTitle
      value: =If(Topic.reason = "Vacation_Hours", "Vacation",If(Topic.reason = "Floating_Holiday_Hours", "Floating Holiday",If(Topic.reason = "Paid_Time_Off_Adjustment_Hours", "Paid Leave", "Unknown")        )      )

    - kind: SetVariable
      id: setRequestString
      variable: Topic.requestString
      value: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{Time_Off_Date}"",""value"":""" & Text(Topic.timeOffDate,"yyyy-MM-dd") & """},{""key"":""{Hours}"",""value"":""" & Text(Topic.hours) & """},{""key"":""{Reason_ID}"",""value"":""" & Topic.reason & """},{""key"":""{Comment}"",""value"":""" & Coalesce(Topic.comment, "") & """}]}"

    - kind: BeginDialog
      id: callWorkday
      displayName: Redirect to Workday System Get Common Execution
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{Time_Off_Date}"",""value"":""" & Text(Topic.timeOffDate,"yyyy-MM-dd") & """},{""key"":""{Hours}"",""value"":""" & Text(Topic.hours) & """},{""key"":""{Reason_ID}"",""value"":""" & Topic.reason & """},{""key"":""{Comment}"",""value"":""" & Coalesce(Topic.comment, "") & """}]}"
          scenarioName: msdyn_HRWorkdayAbsenceEnterTimeOff_EnterTimeOffInfo

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ConditionGroup
      id: outcome
      conditions:
        - id: failed
          condition: =Topic.isSuccess = false
          actions:
            - kind: SendActivity
              id: failMsg
              activity: An error occurred and your time off request was not submitted.

      elseActions:
        - kind: SendActivity
          id: successMsg
          activity: "Your time off request has been submitted for {Text(Topic.timeOffDate,\"yyyy-MM-dd\")}   & {Text(Topic.hours)} hours & Reason: {Topic.reasonTitle}  & Comment: {Topic.comment}"

        - kind: CancelAllDialogs
          id: endDialog

inputType:
  properties:
    comment:
      displayName: comment
      description: Comment supporting the request.
      type: String

    EmployeeName:
      displayName: EmployeeName
      description: The name of the employee to fetch data for.
      type: String

    hours:
      displayName: hours
      description: Number of hours requested for the date.
      type: Number

    reason:
      displayName: reason
      description: Time off reason identifier.
      type: String

    timeOffDate:
      displayName: timeOffDate
      description: The date for the time off request (YYYY-MM-DD).
      type: DateTime

outputType: {}