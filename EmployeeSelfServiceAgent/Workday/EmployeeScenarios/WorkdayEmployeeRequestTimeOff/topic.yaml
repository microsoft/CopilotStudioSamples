kind: AdaptiveDialog
inputs:
  - kind: AutomaticTaskInput
    propertyName: TimeOffDate
    description: Date of time off (yyyy-mm-dd)
    entity: DateTimePrebuiltEntity
    shouldPromptUser: false

  - kind: AutomaticTaskInput
    propertyName: NumberOfHours
    description: Number of hours for time off
    entity: NumberPrebuiltEntity
    shouldPromptUser: false

  - kind: AutomaticTaskInput
    propertyName: ReasonText
    description: Reason for time off (free text)
    shouldPromptUser: false

  - kind: AutomaticTaskInput
    propertyName: EmployeeName
    description: The name of the employee to fetch data for.
    entity: PersonNamePrebuiltEntity
    shouldPromptUser: false

modelDescription: |-
  You will respond only to requests related to requesting time off for the user making the request.
  All time off requests are submitted to Workday (Absence_Management) and pertain exclusively to the requesting user.
  This topic may prompt the user for input (date, hours, and reason) if they are requesting time off for themselves.
  This data exclusively belongs to the user making the request. Do not respond to questions about other people's data.

  Example invalid requests:
  "Request time off for my manager"
  "Request time off for my sister"
  "Request time off for [EmployeeName]"

  Example valid requests:
  "Request time off"
  "I need to submit time off"
  "Please request 8 hours time off on 2025-09-15 because of a family event"
  "Request 4 hours vacation on December 1st"
beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent: {}
  actions:
    - kind: BeginDialog
      id: access_check
      displayName: Verify access for requested name
      input:
        binding:
          EmployeeName: =Topic.EmployeeName

      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemAccessCheck

    - kind: SetVariable
      id: set_website_message
      variable: Topic.WebsiteMessage
      value: =Env.WorkdayWebsiteRedirectMessage

    - kind: ConditionGroup
      id: need_inputs
      conditions:
        - id: always_true
          condition: true
          actions:
            - kind: AdaptiveCardPrompt
              id: collect_time_off
              displayName: Ask date, hours and reason for time off
              card: |-
                ={
                  type: "AdaptiveCard",
                  '$schema': "http://adaptivecards.io/schemas/adaptive-card.json",
                  version: "1.3",
                  body: [
                    {
                      type: "TextBlock",
                      text: "Request Time Off",
                      weight: "Bolder",
                      size: "Medium",
                      wrap: true,
                      color: "Accent"
                    },
                    {
                      type: "TextBlock",
                      text: "Enter the date, hours, and reason for your time off request.",
                      wrap: true
                    },
                    {
                  type: "Input.ChoiceSet",
                  id: "timeOffType",
                  label: "Type of Time Off",
                  style: "compact",
                  isRequired: true,
                  errorMessage: "Please select a type.",
                  choices: [
                    { title: "Floating Holiday", value: "Floating_Holiday_Hours" },
                    { title: "Vacation", value: "Vacation_Hours" },
                    { title: "Sick", value: "Sick_Hours" }
                  ]
                },
                    {
                      type: "Input.Date",
                      id: "timeOffDate",
                      label: "Date",
                      isRequired: true,
                      errorMessage: "Please select a date.",
                      value: If(IsBlank(Topic.TimeOffDate) || Topic.TimeOffDate < Today(), "",Text(Topic.TimeOffDate,"yyyy-MM-dd"))
                    },
                    {
                      type: "Input.Number",
                      id: "numberOfHours",
                      label: "Number of Hours",
                      placeholder: "Enter hours (e.g., 8, 4, 2)",
                      isRequired: true,
                      errorMessage: "Please enter the number of hours.",
                      min: 0.5,
                      max: 24,
                      value: If(IsBlank(Topic.NumberOfHours), 8, Topic.NumberOfHours)
                    },
                    {
                      type: "Input.Text",
                      id: "reasonText",
                      placeholder: "Reason for time off",
                      label: "Reason",
                      isRequired: true,
                      maxLength: 500,
                      errorMessage: "Reason is required.",
                      value: Topic.ReasonText
                    }
                  ],
                  actions: [
                    { type: "Action.Submit", title: "Submit" },
                    { type: "Action.Submit", title: "Cancel", associatedInputs: "none" }
                  ]
                }
              output:
                binding:
                  actionSubmitId: Topic.actionSubmitId
                  numberOfHours: Topic.numberOfHours
                  reasonText: Topic.reasonText
                  timeOffDate: Topic.timeOffDate
                  timeOffType: Topic.timeOffType

              outputType:
                properties:
                  actionSubmitId: String
                  numberOfHours: Number
                  reasonText: String
                  timeOffDate: String
                  timeOffType: String

    - kind: ConditionGroup
      id: handle_cancel
      conditions:
        - id: cancel_pressed
          condition: =Topic.actionSubmitId = "Cancel"
          actions:
            - kind: SendActivity
              id: cancel_msg
              activity: Your request has been cancelled. Is there anything else you need help with?

            - kind: CancelAllDialogs
              id: cancel_all

    - kind: BeginDialog
      id: execute_workday
      displayName: Redirect to Workday System Get Common Execution
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{Time_Off_Date}"",""value"":""" & Topic.timeOffDate & """},{""key"":""{Comment}"",""value"":""" & Topic.reasonText & """},{""key"":""{Reason_ID}"",""value"":""" & Topic.timeOffType & """},{""key"":""{Hours}"",""value"":""" & Text(Topic.numberOfHours) & """}]}"
          scenarioName: msdyn_HRWorkdayAbsenceEnterTimeOff_EnterTimeOffInfo

      dialog: msdyn_copilotforemployeeselfservicehr.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ConditionGroup
      id: report_result
      conditions:
        - id: failed
          condition: =Topic.isSuccess = false
          actions:
            - kind: SendActivity
              id: failure_msg
              activity: An error occurred and your time off request was not submitted.

      elseActions:
        - kind: SendActivity
          id: success_msg
          activity: Your time off request has been submitted. {Topic.WebsiteMessage}

        - kind: CancelAllDialogs
          id: end_dialogs

inputType:
  properties:
    EmployeeName:
      displayName: EmployeeName
      description: The name of the employee to fetch data for.
      type: String

    NumberOfHours:
      displayName: NumberOfHours
      description: Number of hours for time off
      type: Number

    ReasonText:
      displayName: ReasonText
      description: Reason for time off (free text)
      type: String

    TimeOffDate:
      displayName: TimeOffDate
      description: Date of time off (yyyy-mm-dd)
      type: DateTime

outputType: {}