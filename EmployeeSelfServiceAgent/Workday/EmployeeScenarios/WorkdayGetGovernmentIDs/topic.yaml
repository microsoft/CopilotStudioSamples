kind: AdaptiveDialog
modelDescription: |-
  You will respond to requests about the government ids of the user making the request. This data is retrieved from Workday. You will respond to the user based on which piece of data they are asking for. This data exclusively belongs to the user making the request. There is no data for anyone else. Do not respond to questions about other people's data.
  
  Example invalid requests:
  "What are my manager's government ids?"
  "What are my sister's government ids?"
  
  Example valid requests:
  "What are my government ids?"
inputs:
  - kind: AutomaticTaskInput
    propertyName: EmployeeName
    description: The name of the employee whose data is being requested.
    entity: PersonNamePrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0

beginDialog:
  kind: OnRecognizedIntent
  id: main
  intent:
    triggerQueries:
      - What are my Government Ids? 
      - Which Government ids are available on my profile? 
      - Show my Government Ids? 
      - Show me [EmployeeName]'s government Ids

  actions:
    - kind: BeginDialog
      id: GlRaX3
      displayName: Check user access
      input:
        binding:
          EmployeeName: =Topic.EmployeeName

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemAccessCheck

    - kind: BeginDialog
      id: 3bFDxH
      displayName: Redirect to Workday System Get Common Execution
      input:
        binding:
          parameters: ="{""params"":[{""key"":""{Employee_ID}"",""value"":""" & Global.ESS_UserContext_Employee_Id & """},{""key"":""{As_Of_Effective_Date}"",""value"":"""& Text(Today(), "yyyy-MM-dd") &"""}]}"
          scenarioName: msdyn_HRWorkdayHCMEmployeeGetGovernmentIds

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemGetCommonExecution
      output:
        binding:
          errorResponse: Topic.errorResponse
          isSuccess: Topic.isSuccess
          workdayResponse: Topic.workdayResponse

    - kind: ParseValue
      id: v0OBu2
      displayName: Parse workdayResponse into table
      variable: Topic.parsedWorkdayResponse
      valueType:
        kind: Record
        properties:
          GovernmentId:
            type:
              kind: Table
              properties:
                Country_Reference:
                  type:
                    kind: Record
                    properties:
                      ID:
                        type:
                          kind: Table
                          properties:
                            @type: String
                            "#text": String

                Expiration_Date: String
                ID: String
                ID_Type_Reference:
                  type:
                    kind: Record
                    properties:
                      ID:
                        type:
                          kind: Table
                          properties:
                            @type: String
                            "#text": String

                Issued_Date: String

      value: =Topic.workdayResponse

    - kind: BeginDialog
      id: 6k3mYE
      displayName: Refresh country name reference data
      input:
        binding:
          IsTableEmpty: =IsBlank(Global.CountryNameLookupTable)
          ReferenceDataKey: ISO_3166-1_Alpha-2_Code

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemRefreshReferenceData

    - kind: BeginDialog
      id: Xoydcu
      displayName: Refresh government ID type data
      input:
        binding:
          IsTableEmpty: =IsBlank(Global.GovernmentIdTypeLookupTable)
          ReferenceDataKey: Government_ID_Type_ID

      dialog: msdyn_copilotforemployeeselfservice.topic.WorkdaySystemRefreshReferenceData

    - kind: SetVariable
      id: setVariable_ZYrAxQ
      displayName: Get values from reference tables
      variable: Topic.finalizedResponseTableData
      value: |-
        =ForAll(
            Topic.parsedWorkdayResponse.GovernmentId,
            With(
                {currentRecord: ThisRecord},
                {
                    EmployeeName: Global.ESS_UserContext_Employee_Firstname & " " & Global.ESS_UserContext_Employee_Lastname,
                    CountryName: LookUp(
                            Global.CountryNameLookupTable,
                            ID = LookUp(
                                currentRecord.Country_Reference.ID, 
                                '@type' = First(Global.CountryNameLookupTable).Reference_ID_Type
                            ).'#text'
                        ).Referenced_Object_Descriptor,
                    ExpirationDate: currentRecord.Expiration_Date,
                    IDType: LookUp(
                            Global.GovernmentIdTypeLookupTable,
                            ID = LookUp(
                                currentRecord.ID_Type_Reference.ID, 
                                '@type' = First(Global.GovernmentIdTypeLookupTable).Reference_ID_Type
                            ).'#text'
                        ).Referenced_Object_Descriptor,
                    IssuedDate: currentRecord.Issued_Date,
                    ID: ID
                }
            )
        )

inputType:
  properties:
    EmployeeName:
      displayName: EmployeeName
      description: The name of the employee whose data is being requested.
      type: String

outputType:
  properties:
    finalizedResponseTableData:
      displayName: finalizedResponseTableData
      type:
        kind: Table
        properties:
          CountryName: String
          EmployeeName: String
          ExpirationDate: String
          ID: String
          IDType: String
          IssuedDate: String