kind: AdaptiveDialog
inputs:
  - kind: AutomaticTaskInput
    propertyName: CafeName
    description: The name of the cafe to retrieve stations for
    entity: StringPrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

  - kind: AutomaticTaskInput
    propertyName: CafeId
    description: The ID of the cafe to retrieve stations for (more reliable than name)
    entity: StringPrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

modelDescription: |-
  This topic fetches stations for the provided cafe and asks the user to select one.

  The user can say "Show me stations for 31" or "Show me the stations in 31" etc. In these examples, 31 is the cafeName.
beginDialog:
  kind: OnRedirect
  id: main
  actions:
    - kind: SetVariable
      id: setVariable_CurrentDayOfWeek
      variable: Topic.CurrentDayOfWeek
      value: =Mod(Weekday(Now(), StartOfWeek.Monday), 7)

    - kind: SetVariable
      id: setVariable_ApiUrl
      variable: Topic.ApiUrl
      value: |-
        =Concatenate(
            Env.fac_DiningServiceApiUrl, 
            "/api/menus?cafeName=", 
            EncodeUrl(Topic.CafeName),
               "&dayOfWeek=", 
            Text(Topic.CurrentDayOfWeek)
        )

    - kind: HttpRequestAction
      id: httpRequest_GetStations
      url: =Topic.ApiUrl
      headers:
        clientSource: =System.Activity.ChannelId
        Content-Type: application/json
        x-ms-obo-scope: =Env.fac_DiningServiceApiOboScope

      errorHandling:
        kind: ContinueOnErrorBehavior
        statusCode: Topic.CafeStationsStatusCode

      requestTimeoutInMilliseconds: 90000
      response: Topic.CafeStationsResponse
      responseSchema:
        kind: Record
        properties:
          count: Number
          items:
            type:
              kind: Table
              properties:
                cafeId: String
                cafeName: String
                description: String
                id: String
                isAvailableOnline: Boolean
                name: String
                stationId: String
                stationName: String

          metadata: Blank

    - kind: ConditionGroup
      id: conditionGroup_ApiError
      conditions:
        - id: conditionItem_ApiSuccess
          condition: =!IsBlank(Topic.CafeStationsResponse) && Topic.CafeStationsResponse.count > 0
          actions:
            - kind: SetVariable
              id: setVariable_0jCNqg
              variable: Topic.CafeStations
              value: |-
                =ForAll(
                    Topic.CafeStationsResponse.items,
                    {
                        stationId: stationId,
                        cafeId: cafeId,
                        DisplayText: Text(stationName),
                        Value: Text(stationName)
                    }
                )

            - kind: SetVariable
              id: setVariable_StationNames
              variable: Topic.StationNames
              value: |-
                =Distinct(ForAll(
                        Topic.CafeStationsResponse.items,
                        Text(stationName)
                ), Value)

            - kind: ConditionGroup
              id: conditionGroup_CheckStations
              conditions:
                - id: conditionItem_HasStations
                  condition: =!IsEmpty(Topic.StationNames)
                  actions:
                    - kind: ConditionGroup
                      id: conditionGroup_qPZhwJ
                      conditions:
                        - id: conditionItem_Q2tZoT
                          condition: =CountRows(Topic.StationNames) = 1
                          displayName: If the length of Station Names is equal to one
                          actions:
                            - kind: SetVariable
                              id: aBTUCL
                              variable: Topic.StationId
                              value: =LookUp(Topic.CafeStations,Value= First(Topic.StationNames).Value,stationId)

                      elseActions:
                        - kind: Question
                          id: iHiPXO
                          interruptionPolicy:
                            allowInterruption: true

                          variable: Topic.StationName
                          prompt: |-
                            Which station in {Topic.CafeName} do you want to see the menus for?
                            {Char (10) & Concat(
                                Topic.StationNames,
                                "- " & Text(Value) & Char(10)
                            )}

                            Please reply with the **full name of the station** from the list above to see its menu.
                          entity:
                            kind: DynamicClosedListEntity
                            items: =Topic.StationNames
                            samples:

                        - kind: SetVariable
                          id: d2Zb64
                          variable: Topic.StationId
                          value: =LookUp(Topic.CafeStations,Value=Topic.StationName,stationId)

              elseActions:
                - kind: SendActivity
                  id: sendActivity_NoStations
                  activity: Sorry, we couldn't find any stations for {Topic.CafeName}

                - kind: SetVariable
                  id: setVariable_NoStationSelected
                  variable: Topic.StationName
                  value: =""

                - kind: SetVariable
                  id: setVariable_EKAEn4
                  variable: Topic.StationId
                  value: =Blank()

        - id: conditionItem_bL1rlz
          condition: =Topic.CafeStationsStatusCode > 200
          actions:
            - kind: SendActivity
              id: sendActivity_9m6mku
              activity: Sorry, I couldn't retrieve station information at the moment. Please try again later.

            - kind: SetVariable
              id: setVariable_GJtzjn
              variable: Topic.StationName
              value: =""

      elseActions:
        - kind: SendActivity
          id: sendActivity_ApiError
          activity: There are currently no menus available to show

        - kind: SetVariable
          id: setVariable_ErrorStation
          variable: Topic.StationName
          value: =""

inputType:
  properties:
    CafeId:
      displayName: CafeId
      description: The ID of the cafe (more reliable than name)
      type: String

    CafeName:
      displayName: CafeName
      description: The name of the cafe to retrieve stations for
      type: String

outputType:
  properties:
    StationId:
      displayName: StationId
      description: The ID of the selected station
      type: String

    StationName:
      displayName: StationName
      description: Name of the selected station
      type: String
