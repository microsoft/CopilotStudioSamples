kind: AdaptiveDialog
inputs:
  - kind: AutomaticTaskInput
    propertyName: CafeName
    description: (Required) Confirmed cafe name or identifier
    entity: StringPrebuiltEntity
    shouldPromptUser: true

  - kind: AutomaticTaskInput
    propertyName: StationName
    description: (Required) Confirmed station name or identifier
    entity: StringPrebuiltEntity
    shouldPromptUser: true

  - kind: AutomaticTaskInput
    propertyName: CafeId
    description: (Optional) The ID of the cafe to retrieve menus for (more reliable)
    entity: StringPrebuiltEntity
    shouldPromptUser: false
    inputSettings:
      repeatCount: 0
      defaultValue: =Blank()

modelDescription: This topic retrieves the menus available at a specified cafe and station.
beginDialog:
  kind: OnRedirect
  id: main
  actions:
    - kind: SetVariable
      id: setVariable_ApiUrl
      variable: Topic.ApiUrl
      value: |-
        =Concatenate(
            Env.fac_DiningServiceApiUrl,
            "/api/menus?cafeName=",
            EncodeUrl(Topic.CafeName),
            "&stationName=",
            EncodeUrl(Topic.StationName)
        )

    - kind: HttpRequestAction
      id: bBZmwA
      url: =Topic.ApiUrl
      headers:
        clientSource: =System.Activity.ChannelId
        Content-Type: application/json
        x-ms-obo-scope: =Env.fac_DiningServiceApiOboScope

      errorHandling:
        kind: ContinueOnErrorBehavior
        statusCode: Topic.CafeStationMenusStatusCode

      requestTimeoutInMilliseconds: 90000
      response: Topic.CafeStationMenus
      responseSchema:
        kind: Record
        properties:
          count: Number
          items:
            type:
              kind: Table
              properties:
                cafeName: String
                isAvailableOnline: Boolean
                items:
                  type:
                    kind: Table
                    properties:
                      name: String

                name: String
                stationName: String

    - kind: ConditionGroup
      id: conditionGroup_CheckResults
      conditions:
        - id: conditionItem_HasMenus
          condition: =!IsBlank(Topic.CafeStationMenus) && CountRows(Topic.CafeStationMenus.items) > 0

      elseActions:
        - kind: SetVariable
          id: setVariable_EmptyMenus
          variable: Topic.CafeStationMenus
          value: |-
            ={
                count: 0,
                items: []
            }

inputType:
  properties:
    CafeId:
      displayName: CafeId
      description: (Optional) The ID of the cafe to retrieve menus for (more reliable)
      type: String

    CafeName:
      displayName: CafeName
      description: (Required) Confirmed cafe name or identifier
      type: String

    StationName:
      displayName: StationName
      description: (Required) Confirmed station name or identifier
      type: String

outputType:
  properties:
    CafeStationMenus:
      displayName: CafeStationMenus
      type:
        kind: Record
        properties:
          count: Number
          items:
            type:
              kind: Table
              properties:
                cafeId: String
                cafeName: String
                isAvailableOnline: Boolean
                items:
                  type:
                    kind: Table
                    properties:
                      name: String

                name: String
                stationId: String
                stationName: String
