<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Copilot Chat</title>
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/botframework-webchat@4.18.1-main.20241015.4744d69/dist/webchat.js"></script>
    <script
        src="https://unpkg.com/botframework-webchat-fluent-theme@4.18.1-main.20241015.4744d69/dist/botframework-webchat-fluent-theme.production.min.js"></script>
    <script
        src="https://unpkg.com/copilot-studio-direct-to-engine-chat-adapter@0.0.0-main.20241022-173702.3e37c28/dist/copilot-studio-direct-to-engine-chat-adapter.production.global.js"></script>
    <script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
    <style>
        html,
        body,
        #webchat {
            height: 100%;
            margin: 0;
        }

        #auth-error {
            color: #b00020;
            background: #fff4f4;
            padding: 1em;
            text-align: center;
            font-family: sans-serif;
        }

        #retry-auth {
            display: block;
            margin: 1em auto;
            padding: 0.6em 1.2em;
            background: #0078d4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
    </style>
</head>

<body>
    <div id="webchat" role="main"></div>

    <script>
        const msalInstance = new msal.PublicClientApplication({
            auth: {
                clientId: "40347a26-35bb-48f3-bdc4-7f4f209aecb1",
                authority: "https://login.microsoftonline.com/8a235459-3d2c-415d-8c1e-e2fe133509ad",
                redirectUri: window.location.origin
            },
            cache: {
                cacheLocation: "localStorage",
                storeAuthStateInCookie: true
            }
        });

        const loginRequest = {
            scopes: ["https://api.powerplatform.com/CopilotStudio.Copilots.Invoke"]
        };

        async function getToken() {
            const accounts = msalInstance.getAllAccounts();

            if (accounts.length > 0) {
                const silentRequest = {
                    ...loginRequest,
                    account: accounts[0]
                };
                const result = await msalInstance.acquireTokenSilent(silentRequest);
                return result.accessToken;
            } else {
                const result = await msalInstance.loginPopup({ ...loginRequest, prompt: "consent" });
                return result.accessToken;
            }
        }

        function startChat(token) {
            const strategy = new window.CopilotStudioDirectToEngineChatAdapter.ThirdPartyPublishedBotStrategy({
                botSchema: 'cr26e_stramingResponse',
                environmentEndpointURL: new URL('https://6cc0c98e3fe6e0d58ebaba51c9da1d.13.environment.api.powerplatform.com/'),
                getToken: () => token,
                transport: 'auto'
            });

            const directLine = window.CopilotStudioDirectToEngineChatAdapter.toDirectLineJS(
                window.CopilotStudioDirectToEngineChatAdapter.createHalfDuplexChatAdapter(strategy, { emitStartConversationEvent: true })
            );


            const {
                React: { createElement },
                ReactDOM: { render },
                WebChat: { FluentThemeProvider, ReactWebChat }
            } = window;

            const store = WebChat.createStore(
                {},
                ({ dispatch }) => next => action => {
                    const { type } = action;

                   
                     console.log('Activity type:', action.payload?.activity);
                    return next(action);

                });

            render(
                createElement(FluentThemeProvider, {}, createElement(ReactWebChat, { directLine, store, locale: 'en-US' })),
                document.getElementById('webchat')
            );
        }

        function showError(message) {
            let el = document.getElementById('auth-error');
            if (!el) {
                el = document.createElement('div');
                el.id = 'auth-error';
                document.body.insertBefore(el, document.getElementById('webchat'));
            }
            el.innerText = message;

            let btn = document.getElementById('retry-auth');
            if (!btn) {
                btn = document.createElement('button');
                btn.id = 'retry-auth';
                btn.innerText = 'Retry Authentication';
                btn.onclick = () => {
                    el.remove();
                    btn.remove();
                    init();
                };
                el.after(btn);
            }
        }

        async function init() {
            try {
                const token = await getToken();
                startChat(token);
            } catch (e) {
                showError(e.message || "Authentication failed.");
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>